'use strict';

var _util = require('../util');

var DUPLICATE_MESSAGE = 'The action {{actionType}} is already defined';

module.exports = function (context) {
  var errors = [];

  var alreadyDefined = {};

  /**
   * Report errors
   */
  function reportErrors() {
    errors.forEach(function (node) {
      context.report(node, DUPLICATE_MESSAGE, {
        actionType: node.value || node.name
      });
    });
  }

  return {
    Program: function Program(node) {
      node.body.forEach(function (child) {
        var actionDefinitionNode = void 0;
        if (child.type === 'ExportNamedDeclaration') {
          actionDefinitionNode = (((child.declaration || {}).declarations || [])[0] || {}).init;
        } else if (child.type === 'ExpressionStatement') {
          actionDefinitionNode = (child.expression || {}).right;
        }

        if (!actionDefinitionNode || !(0, _util.isDefineActionCall)(actionDefinitionNode)) {
          return;
        }

        var actionTypeNode = (0, _util.getActionType)(actionDefinitionNode);

        if (alreadyDefined[actionTypeNode.value || actionTypeNode.name]) {
          errors.push(actionTypeNode);
        } else {
          alreadyDefined[actionTypeNode.value || actionTypeNode.name] = 1;
        }
      });
      reportErrors();
    }
  };
};

module.exports.schema = [];